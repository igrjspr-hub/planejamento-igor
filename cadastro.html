<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DigitalDM • Painel de Leads (Closer)</title>

  <!-- PDF libs (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --line:rgba(255,255,255,.08);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --accent:#7c5cff;
      --good:#22c55e;
      --warn:#f59e0b;
      --info:#38bdf8;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.24), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(56,189,248,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1250px;margin:26px auto;padding:0 16px 40px}
    .topbar{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:18px 18px;border:1px solid var(--line);border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:0 18px 60px rgba(0,0,0,.35);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg, var(--accent), rgba(56,189,248,.95));
      box-shadow:0 10px 30px rgba(124,92,255,.25);
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.35}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;font-weight:700;font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(124,92,255,.45)}
    .btn.primary{background:rgba(124,92,255,.18);border-color:rgba(124,92,255,.55)}
    .btn.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.42)}
    .btn.bad{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.40)}
    .grid{
      margin-top:14px;
      display:grid;grid-template-columns:repeat(12,1fr);gap:12px;
    }
    .card{
      grid-column:span 3;
      padding:14px 14px;border-radius:16px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .card h3{margin:0;font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.3px;text-transform:uppercase}
    .card .big{margin-top:8px;font-size:22px;font-weight:900}
    .card .small{margin-top:6px;color:var(--muted2);font-size:12px;line-height:1.35}
    .card.span6{grid-column:span 6}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:12px;border:1px solid var(--line);border-radius:16px;
      background:rgba(255,255,255,.03);
      min-width:220px;
    }
    label{font-size:11px;color:var(--muted);font-weight:800;letter-spacing:.25px;text-transform:uppercase}
    input, select{
      outline:none;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.12);color:var(--text);
      padding:10px 10px;border-radius:12px;
      font-size:13px;
    }
    input::placeholder{color:rgba(234,240,255,.40)}
    .hint{margin-top:12px;color:var(--muted2);font-size:12px;line-height:1.4}
    .tableWrap{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:rgba(255,255,255,.02);
    }
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      text-align:left;
      font-size:11px;letter-spacing:.35px;text-transform:uppercase;
      color:var(--muted);
      padding:14px 12px;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:2;
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
      color:rgba(234,240,255,.92);
    }
    tbody tr:hover{background:rgba(124,92,255,.06)}
    .rank{
      font-weight:900;color:#fff;
      background:rgba(124,92,255,.14);
      border:1px solid rgba(124,92,255,.45);
      width:34px;height:34px;border-radius:12px;
      display:inline-grid;place-items:center;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .pill.imediato{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12);color:#bff7d1}
    .pill.semana{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12);color:#ffe3b0}
    .pill.mes{border-color:rgba(56,189,248,.35);background:rgba(56,189,248,.12);color:#c7f0ff}
    .pill.fat{border-color:rgba(124,92,255,.45);background:rgba(124,92,255,.12);color:#ddd6ff}
    .pill.fil{border-color:rgba(148,163,184,.35);background:rgba(148,163,184,.10);color:#e2e8f0}
    .chip{display:inline-flex;align-items:center;gap:8px}
    .copy{cursor:pointer;font-weight:900;color:#c7f0ff;border-bottom:1px dashed rgba(199,240,255,.45)}
    .editable{outline:none;border-radius:8px;padding:6px 8px}
    .editable:focus{box-shadow:0 0 0 3px rgba(124,92,255,.25);background:rgba(124,92,255,.08)}
    .muted{color:var(--muted2)}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:50;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:0 20px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--line);
    }
    .modalHead b{font-size:14px}
    .modalBody{padding:16px}
    .formGrid{
      display:grid;grid-template-columns:repeat(12,1fr);gap:12px;
    }
    .span12{grid-column:span 12}
    .span6{grid-column:span 6}
    .span4{grid-column:span 4}
    .span3{grid-column:span 3}
    .modalFoot{
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      padding:14px 16px;border-top:1px solid var(--line);
    }

    @media (max-width: 980px){
      .card{grid-column:span 6}
      .card.span6{grid-column:span 12}
      .field{min-width:unset;width:100%}
      .formGrid .span6,.formGrid .span4,.formGrid .span3{grid-column:span 12}
      thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tbody td{border-bottom:none}
      tbody tr{border-bottom:1px solid var(--line);padding:8px 0}
      tbody td[data-label]::before{
        content:attr(data-label);
        display:block;
        color:var(--muted);
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:.3px;
        margin-bottom:6px;
        font-weight:900;
      }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>DigitalDM • Painel de Leads (Closer)</h1>
        <div class="sub">
          Prioridade automática: <b>Urgência</b> (mais importante) → <b>Faturamento</b> → <b>Data de entrada</b> (mais antigo primeiro, pra não esfriar).
          <br><span class="muted">Você pode adicionar lead manualmente e baixar a lista em <b>TXT</b> ou <b>PDF</b>.</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn good" id="btnAdd">+ Adicionar Lead</button>
      <button class="btn primary" id="btnSort">Reordenar</button>
      <button class="btn" id="btnTxt">Baixar TXT</button>
      <button class="btn" id="btnPdf">Baixar PDF</button>
      <button class="btn bad" id="btnClear">Limpar tudo</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Total de Leads</h3>
      <div class="big" id="kpiTotal">0</div>
      <div class="small">Leads na lista.</div>
    </div>
    <div class="card">
      <h3>Imediato</h3>
      <div class="big" id="kpiImediato">0</div>
      <div class="small">Maior prioridade.</div>
    </div>
    <div class="card">
      <h3>Semana que vem</h3>
      <div class="big" id="kpiSemana">0</div>
      <div class="small">Prioridade média.</div>
    </div>
    <div class="card">
      <h3>Mês que vem</h3>
      <div class="big" id="kpiMes">0</div>
      <div class="small">Menor prioridade.</div>
    </div>

    <div class="card span6">
      <h3>Filtros rápidos</h3>
      <div class="filters">
        <div class="field">
          <label>Buscar</label>
          <input id="q" type="text" placeholder="empresa, estado, telefone..." />
        </div>
        <div class="field">
          <label>Urgência</label>
          <select id="fUrg">
            <option value="">Todas</option>
            <option value="Imediato">Imediato</option>
            <option value="Semana que vem">Semana que vem</option>
            <option value="Mês que vem">Mês que vem</option>
          </select>
        </div>
        <div class="field">
          <label>Estado (UF)</label>
          <select id="fUF">
            <option value="">Todos</option>
            <option value="SP">SP</option>
            <option value="RJ">RJ</option>
            <option value="SC">SC</option>
            <option value="—">—</option>
          </select>
        </div>
      </div>
      <div class="hint">
        ✅ Edite direto na tabela (clique e digite). Tudo salva automaticamente no navegador (localStorage).
      </div>
    </div>

    <div class="card span6">
      <h3>Regras de prioridade</h3>
      <div class="small">
        1) <b>Urgência</b> (Imediato &gt; Semana que vem &gt; Mês que vem)<br>
        2) <b>Faturamento</b> (+150K &gt; 50–150K &gt; 20–50K &gt; 10–50K &gt; 20K &gt; Filantrópico)<br>
        3) <b>Data de entrada</b>: mais antigo primeiro (pra não perder timing).<br><br>
        Exportações: <b>TXT</b> (lista para Whats) e <b>PDF</b> (relatório com ranking).
      </div>
    </div>
  </div>

  <div class="tableWrap">
    <table id="leads">
      <thead>
        <tr>
          <th style="width:64px;">#</th>
          <th>Empresa</th>
          <th style="width:90px;">UF</th>
          <th style="width:170px;">Telefone</th>
          <th style="width:140px;">Faturamento</th>
          <th style="width:140px;">Data entrada</th>
          <th style="width:170px;">Quando quer atendimento</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="hint">
    Dica: clique em <b>Baixar TXT</b> pra ter a lista pronta pra colar no WhatsApp.
  </div>
</div>

<!-- Modal: Add Lead -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <b>Adicionar Lead Manualmente</b>
      <button class="btn" id="btnClose">Fechar</button>
    </div>

    <div class="modalBody">
      <div class="formGrid">
        <div class="field span12">
          <label>Nome da empresa</label>
          <input id="inEmpresa" placeholder="Ex: Martin Odontologia Integrada" />
        </div>

        <div class="field span3">
          <label>Estado (UF)</label>
          <input id="inUF" placeholder="SP / RJ / SC" />
        </div>

        <div class="field span4">
          <label>Telefone</label>
          <input id="inTel" placeholder="Somente números (ex: 11999999999)" />
        </div>

        <div class="field span5">
          <label>Faturamento</label>
          <select id="inFat">
            <option value="+150K">+150K</option>
            <option value="50-150K">50-150K</option>
            <option value="20-50K">20-50K</option>
            <option value="10-50K">10-50K</option>
            <option value="20K">20K</option>
            <option value="Filantrópico">Filantrópico</option>
          </select>
        </div>

        <div class="field span6">
          <label>Data que entrou o lead</label>
          <input id="inDate" type="date" />
        </div>

        <div class="field span6">
          <label>Quando ele quer o atendimento</label>
          <select id="inUrg">
            <option value="Imediato">Imediato</option>
            <option value="Semana que vem">Semana que vem</option>
            <option value="Mês que vem">Mês que vem</option>
          </select>
        </div>
      </div>

      <div class="hint">
        ✅ Ao salvar, o lead entra na lista e o ranking é recalculado automaticamente.
      </div>
    </div>

    <div class="modalFoot">
      <button class="btn bad" id="btnCancel">Cancelar</button>
      <button class="btn good" id="btnSave">Salvar Lead</button>
    </div>
  </div>
</div>

<script>
  // -------------------- Data model (localStorage) --------------------
  const LS_KEY = "digitaldm_leads_v1";

  /** @type {{empresa:string, uf:string, tel:string, fat:string, date:string, urg:string}[]} */
  let leads = [];

  // -------------------- Helpers --------------------
  const urgencyWeight = (u) => {
    const s = (u || "").toLowerCase();
    if (s.includes("imediato")) return 3;
    if (s.includes("semana")) return 2;
    if (s.includes("mês") || s.includes("mes")) return 1;
    return 0;
  };

  const revenueValue = (fatRaw) => {
    const f = (fatRaw || "").toLowerCase().replace(/\s/g,'');
    if (f.includes("filantr")) return 19000;
    if (f.includes("+150")) return 150000;
    if (f.includes("50-150")) return 100000;
    if (f.includes("20-50")) return 35000;
    if (f.includes("10-50")) return 30000;
    if (f.includes("20k")) return 20000;
    // fallback
    const m = f.match(/(\d{2,6})/g);
    if (!m) return 0;
    const nums = m.map(n=>parseInt(n,10)).filter(n=>!Number.isNaN(n));
    return nums.length ? Math.max(...nums) : 0;
  };

  const ddmmyyFromISO = (iso) => {
    // iso: yyyy-mm-dd -> dd-mm-yy
    if (!iso) return "—";
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return "—";
    const yy = m[1].slice(2);
    return `${m[3]}-${m[2]}-${yy}`;
  };

  const isoFromDDMMYY = (d) => {
    // dd-mm-yy -> 20yy-mm-dd
    const m = (d||"").trim().match(/^(\d{2})-(\d{2})-(\d{2})$/);
    if (!m) return "";
    const yyyy = "20"+m[3];
    return `${yyyy}-${m[2]}-${m[1]}`;
  };

  const dateValue = (ddmmyy) => {
    // use ISO timestamp for sorting; if missing, put very large (so goes last when sorting oldest first)
    const iso = isoFromDDMMYY(ddmmyy);
    if (!iso) return Number.POSITIVE_INFINITY;
    const dt = new Date(iso);
    const t = dt.getTime();
    return Number.isFinite(t) ? t : Number.POSITIVE_INFINITY;
  };

  const pillUrgClass = (u) => {
    const s = (u || "").toLowerCase();
    if (s.includes("imediato")) return "imediato";
    if (s.includes("semana")) return "semana";
    return "mes";
  };

  const pillFatClass = (f) => (String(f||"").toLowerCase().includes("filantr") ? "fil" : "fat");

  const saveLS = () => localStorage.setItem(LS_KEY, JSON.stringify(leads));
  const loadLS = () => {
    try{
      const raw = localStorage.getItem(LS_KEY);
      leads = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(leads)) leads = [];
    } catch { leads = []; }
  };

  // -------------------- Sorting (Urgência > Faturamento > Data mais antiga) --------------------
  function sortLeads(){
    leads.sort((a,b)=>{
      const uwA = urgencyWeight(a.urg), uwB = urgencyWeight(b.urg);
      if (uwA !== uwB) return uwB - uwA;

      const rvA = revenueValue(a.fat), rvB = revenueValue(b.fat);
      if (rvA !== rvB) return rvB - rvA;

      // date: older first
      const dvA = dateValue(a.date), dvB = dateValue(b.date);
      return dvA - dvB;
    });
  }

  // -------------------- Render --------------------
  function updateKPIs(){
    document.getElementById("kpiTotal").textContent = leads.length;
    document.getElementById("kpiImediato").textContent = leads.filter(l=>urgencyWeight(l.urg)===3).length;
    document.getElementById("kpiSemana").textContent = leads.filter(l=>urgencyWeight(l.urg)===2).length;
    document.getElementById("kpiMes").textContent = leads.filter(l=>urgencyWeight(l.urg)===1).length;
  }

  function render(){
    sortLeads();
    saveLS();
    updateKPIs();

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    leads.forEach((l, idx)=>{
      const tr = document.createElement("tr");
      tr.dataset.idx = String(idx);

      tr.innerHTML = `
        <td data-label="#"><span class="rank">${idx+1}</span></td>

        <td data-label="Empresa" class="editable" contenteditable="true" data-k="empresa">${escapeHtml(l.empresa)}</td>

        <td data-label="UF" class="editable" contenteditable="true" data-k="uf">${escapeHtml(l.uf || "—")}</td>

        <td data-label="Telefone">
          <span class="chip">
            <span class="editable" contenteditable="true" data-k="tel">${escapeHtml(l.tel || "—")}</span>
            <span class="copy" data-copy="${escapeHtml(l.tel || "")}">copiar</span>
          </span>
        </td>

        <td data-label="Faturamento">
          <span class="pill ${pillFatClass(l.fat)} editable" contenteditable="true" data-k="fat">${escapeHtml(l.fat)}</span>
        </td>

        <td data-label="Data entrada" class="editable" contenteditable="true" data-k="date">${escapeHtml(l.date || "—")}</td>

        <td data-label="Quando quer atendimento">
          <span class="pill ${pillUrgClass(l.urg)} editable" contenteditable="true" data-k="urg">${escapeHtml(l.urg)}</span>
        </td>
      `;
      tbody.appendChild(tr);
    });

    applyFilters();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // -------------------- Editing inline --------------------
  let editTimer = null;
  document.addEventListener("input", (e)=>{
    const el = e.target;
    if (!el.closest("#leads")) return;
    const row = el.closest("tr");
    if (!row) return;

    clearTimeout(editTimer);
    editTimer = setTimeout(()=>{
      const idx = parseInt(row.dataset.idx,10);
      if (!Number.isFinite(idx) || !leads[idx]) return;

      const key = el.dataset.k;
      if (!key) return;

      let val = (el.innerText || "").trim();

      // Normalize UF
      if (key === "uf") {
        val = val ? val.toUpperCase() : "—";
      }

      // Normalize date (allow ISO typed or dd-mm-yy)
      if (key === "date") {
        if (/^\d{4}-\d{2}-\d{2}$/.test(val)) val = ddmmyyFromISO(val);
        if (!/^\d{2}-\d{2}-\d{2}$/.test(val)) val = "—";
      }

      // Normalize urg
      if (key === "urg") {
        const low = val.toLowerCase();
        if (low.includes("imedi")) val = "Imediato";
        else if (low.includes("semana")) val = "Semana que vem";
        else val = "Mês que vem";
      }

      // Normalize fat
      if (key === "fat") {
        const low = val.toLowerCase();
        if (low.includes("+150")) val = "+150K";
        else if (low.includes("50") && low.includes("150")) val = "50-150K";
        else if (low.includes("20") && low.includes("50")) val = "20-50K";
        else if (low.includes("10") && low.includes("50")) val = "10-50K";
        else if (low.includes("filantr")) val = "Filantrópico";
        else if (low.includes("20k") || low === "20") val = "20K";
      }

      leads[idx][key] = val;
      render(); // re-render to re-rank and refresh pills
    }, 450);
  });

  // Copy phone
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-copy]");
    if(!btn) return;
    const tel = (btn.getAttribute("data-copy") || "").trim();
    if(!tel) return alert("Telefone vazio.");
    navigator.clipboard.writeText(tel).then(()=>{
      btn.textContent = "copiado";
      setTimeout(()=>btn.textContent="copiar", 900);
    });
  });

  // -------------------- Filters --------------------
  function applyFilters(){
    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    const fUrg = document.getElementById("fUrg").value;
    const fUF = document.getElementById("fUF").value;

    const rows = Array.from(document.querySelectorAll("#tbody tr"));
    rows.forEach((r)=>{
      const idx = parseInt(r.dataset.idx,10);
      const l = leads[idx];

      const hay = `${l.empresa} ${l.uf} ${l.tel} ${l.fat} ${l.date} ${l.urg}`.toLowerCase();
      const okQ = !q || hay.includes(q);
      const okU = !fUrg || l.urg === fUrg;
      const okUF = !fUF || (l.uf || "—") === fUF;

      r.style.display = (okQ && okU && okUF) ? "" : "none";
    });
  }

  ["q","fUrg","fUF"].forEach(id=>{
    document.getElementById(id).addEventListener("input", applyFilters);
    document.getElementById(id).addEventListener("change", applyFilters);
  });

  // -------------------- Export TXT --------------------
  function buildTxt(){
    sortLeads();
    const dt = new Date();
    const header =
`DIGITALDM • LISTA DE PRIORIDADE (LIGAÇÃO/ATENDIMENTO)
Gerado em: ${dt.toLocaleString("pt-BR")}

Regras: Urgência > Faturamento > Data (mais antigo primeiro)

`;

    const lines = leads.map((l,i)=>{
      const uf = l.uf || "—";
      const date = l.date || "—";
      return `${i+1}) ${l.empresa} — ${uf} — ${l.tel || "—"} — ${l.fat} — ${date} — ${l.urg}`;
    });

    const footer = `

Resumo:
- Total: ${leads.length}
- Imediato: ${leads.filter(x=>x.urg==="Imediato").length}
- Semana que vem: ${leads.filter(x=>x.urg==="Semana que vem").length}
- Mês que vem: ${leads.filter(x=>x.urg==="Mês que vem").length}
`;
    return header + lines.join("\n") + footer;
  }

  function downloadTxt(){
    const text = buildTxt();
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "digitaldm_leads_prioridade.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // -------------------- Export PDF --------------------
  async function downloadPdf(){
    sortLeads();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:"portrait", unit:"pt", format:"a4"});

    const title = "DigitalDM • Lista de Prioridade (Ligação/Atendimento)";
    const now = new Date().toLocaleString("pt-BR");

    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text(title, 40, 48);

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`Gerado em: ${now}`, 40, 66);
    doc.text("Regras: Urgência > Faturamento > Data (mais antigo primeiro)", 40, 82);

    const body = leads.map((l,i)=>[
      String(i+1),
      l.empresa,
      (l.uf || "—"),
      (l.tel || "—"),
      l.fat,
      (l.date || "—"),
      l.urg
    ]);

    doc.autoTable({
      startY: 100,
      head: [["#", "Empresa", "UF", "Telefone", "Faturamento", "Data", "Urgência"]],
      body,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 6 },
      headStyles: { fillColor: [124, 92, 255], textColor: 255, fontStyle: "bold" },
      alternateRowStyles: { fillColor: [245, 245, 255] },
      columnStyles: {
        0: { cellWidth: 26 },
        1: { cellWidth: 180 },
        2: { cellWidth: 36 },
        3: { cellWidth: 96 },
        4: { cellWidth: 74 },
        5: { cellWidth: 62 },
        6: { cellWidth: 78 }
      },
      didDrawPage: function (data) {
        const pageSize = doc.internal.pageSize;
        const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text(`Total: ${leads.length} | Imediato: ${leads.filter(x=>x.urg==="Imediato").length} | Semana: ${leads.filter(x=>x.urg==="Semana que vem").length} | Mês: ${leads.filter(x=>x.urg==="Mês que vem").length}`,
          40, pageHeight - 22
        );
      }
    });

    doc.save("digitaldm_leads_prioridade.pdf");
  }

  // -------------------- Modal controls --------------------
  const modalBack = document.getElementById("modalBack");
  const openModal = ()=>{ modalBack.style.display="flex"; };
  const closeModal = ()=>{ modalBack.style.display="none"; };

  document.getElementById("btnAdd").addEventListener("click", openModal);
  document.getElementById("btnClose").addEventListener("click", closeModal);
  document.getElementById("btnCancel").addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

  document.getElementById("btnSave").addEventListener("click", ()=>{
    const empresa = (document.getElementById("inEmpresa").value || "").trim();
    const uf = ((document.getElementById("inUF").value || "—").trim() || "—").toUpperCase();
    const tel = (document.getElementById("inTel").value || "").trim();
    const fat = document.getElementById("inFat").value;
    const iso = document.getElementById("inDate").value; // yyyy-mm-dd
    const date = ddmmyyFromISO(iso);
    const urg = document.getElementById("inUrg").value;

    if(!empresa){
      alert("Preencha o nome da empresa.");
      return;
    }

    leads.push({
      empresa,
      uf: uf || "—",
      tel: tel || "—",
      fat,
      date: date === "—" ? "—" : date,
      urg
    });

    // reset fields
    document.getElementById("inEmpresa").value = "";
    document.getElementById("inUF").value = "";
    document.getElementById("inTel").value = "";
    document.getElementById("inDate").value = "";
    document.getElementById("inUrg").value = "Imediato";
    document.getElementById("inFat").value = "+150K";

    closeModal();
    render();
  });

  // -------------------- Buttons --------------------
  document.getElementById("btnSort").addEventListener("click", render);
  document.getElementById("btnTxt").addEventListener("click", downloadTxt);
  document.getElementById("btnPdf").addEventListener("click", downloadPdf);

  document.getElementById("btnClear").addEventListener("click", ()=>{
    if(confirm("Tem certeza que deseja apagar TODOS os leads salvos neste navegador?")){
      leads = [];
      saveLS();
      render();
    }
  });

  // -------------------- Initial data (your list) --------------------
  const seed = [
    // (urgência é mais importante; data antiga primeiro dentro do empate)
    { empresa:"Ministério da Gestão e da Inovação em Serviços Públicos", uf:"—", tel:"41996866676", fat:"+150K", date:"—",       urg:"Mês que vem" },
    { empresa:"Emagrecentro", uf:"SC", tel:"4999573641", fat:"+150K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Instituto Venturo", uf:"RJ", tel:"21981087665", fat:"50-150K", date:"31-12-25", urg:"Imediato" },
    { empresa:"DOM Shampoo", uf:"SP", tel:"11958638580", fat:"50-150K", date:"31-12-25", urg:"Imediato" },
    { empresa:"MR Móveis", uf:"SC", tel:"49999122411", fat:"50-150K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Centro Veterinário Palmense", uf:"SC", tel:"4991554810", fat:"50-150K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Clínica Marcelo Monteiro", uf:"RJ", tel:"21998420888", fat:"20-50K", date:"01-01-26", urg:"Mês que vem" },
    { empresa:"Ivonete Dellalana (sem empresa)", uf:"SP", tel:"19995614276", fat:"10-50K", date:"01-01-26", urg:"Semana que vem" },
    { empresa:"Voga Modas", uf:"SP", tel:"11930112247", fat:"20K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Consultório Médico Esperança", uf:"RJ", tel:"21970383876", fat:"20K", date:"01-01-26", urg:"Mês que vem" },
    { empresa:"Ai Press (Comunicação/Audiovisual)", uf:"SP", tel:"11972759856", fat:"20K", date:"01-01-26", urg:"Mês que vem" },
    { empresa:"Electric Sheep", uf:"RJ", tel:"21996173417", fat:"20K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Sas Seconci", uf:"SP", tel:"11951424541", fat:"Filantrópico", date:"01-01-26", urg:"Imediato" },
    { empresa:"Consultório Odontológico Particular", uf:"SP", tel:"11982254499", fat:"20K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Consultório Dentário", uf:"SP", tel:"13997217914", fat:"20K", date:"01-01-26", urg:"Mês que vem" },
    { empresa:"IMI (Instituto de Metrologia Industrial)", uf:"RJ", tel:"21990448265", fat:"20K", date:"01-01-26", urg:"Imediato" },
    { empresa:"Dra. Fabiana Balan", uf:"SP", tel:"11914407034", fat:"20K", date:"01-01-26", urg:"Mês que vem" },
    { empresa:"Ateliê do Sorriso", uf:"RJ", tel:"21971652149", fat:"20-50K", date:"01-01-26", urg:"Imediato" },
    { empresa:"IJESP - Instituto de Joelho de São Paulo", uf:"SP", tel:"—", fat:"20-50K", date:"01-01-26", urg:"Imediato" }
  ];

  function init(){
    loadLS();
    if (!leads.length){
      leads = seed;
      saveLS();
    }
    render();
  }
  init();
</script>
</body>
</html>

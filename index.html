<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador Financeiro (05/15/20) — Planejamento</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f1730;
      --line:rgba(255,255,255,.12);
      --txt:#eaf0ff;
      --muted:rgba(234,240,255,.75);
      --good:#31d07d;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --blue:#5db2ff;
      --chip:rgba(93,178,255,.14);
      --shadow: 0 14px 40px rgba(0,0,0,.28);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(93,178,255,.25), transparent 60%),
                  radial-gradient(800px 500px at 90% 10%, rgba(49,208,125,.22), transparent 60%),
                  linear-gradient(180deg, #070b14 0%, #0b1220 100%);
    }
    header{
      padding:20px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(17,26,46,.55);
      backdrop-filter: blur(10px);
      position: sticky;
      top:0;
      z-index: 50;
    }
    .wrap{ max-width: 1120px; margin: 0 auto; }
    h1{ margin:0; font-size: 18px; letter-spacing:.2px; }
    .sub{ margin-top:6px; font-size: 12px; color:var(--muted); }
    main{ padding: 18px 16px 44px; }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: rgba(17,26,46,.65);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(15,23,48,.6);
    }
    .title{ font-size: 13px; font-weight: 700; }
    .tools{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:8px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{ background: rgba(93,178,255,.18); border-color: rgba(93,178,255,.35); }
    .btn.danger{ background: rgba(255,92,122,.14); border-color: rgba(255,92,122,.35); }
    .btn.good{ background: rgba(49,208,125,.14); border-color: rgba(49,208,125,.35); }
    .body{ padding: 12px 14px; }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    @media (max-width: 720px){
      .row{ grid-template-columns: 1fr; }
    }
    label{ font-size: 11px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline:none;
      font-size: 13px;
    }
    input::placeholder{ color: rgba(234,240,255,.35); }
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border: 1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 12px;
      padding:10px;
    }
    .item .top{
      display:grid;
      grid-template-columns: 1.5fr .6fr .7fr .6fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 900px){
      .item .top{ grid-template-columns: 1fr 1fr; }
    }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      font-size: 11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .chip.blue{ background: rgba(93,178,255,.16); color: #cfe7ff; border-color: rgba(93,178,255,.35); }
    .chip.good{ background: rgba(49,208,125,.14); color: #d8ffe9; border-color: rgba(49,208,125,.35); }
    .chip.warn{ background: rgba(255,209,102,.14); color: #fff0c7; border-color: rgba(255,209,102,.35); }
    .chip.bad{ background: rgba(255,92,122,.14); color: #ffd0db; border-color: rgba(255,92,122,.35); }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 12px;
      padding:10px;
    }
    .kpi .l{ font-size: 11px; color: var(--muted); }
    .kpi .v{ font-size: 16px; font-weight: 800; margin-top:4px; }
    .kpi .h{ font-size: 11px; color: var(--muted); margin-top:6px; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size: 12px;
      margin-top: 10px;
    }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    th{ text-align:left; color:var(--muted); font-weight:700; }
    td.r, th.r{ text-align:right; white-space:nowrap; }
    .mono{ font-family: var(--mono); }
    .note{
      margin-top:10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .ok{ color: var(--good); font-weight: 800; }
    .warn{ color: var(--warn); font-weight: 800; }
    .bad{ color: var(--bad); font-weight: 800; }
    .hr{
      height:1px; background: var(--line);
      margin: 12px 0;
    }
    .small{ font-size: 11px; color: var(--muted); }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Simulador Financeiro (Ciclo 05 / 15 / 20)</h1>
    <div class="sub">Edite entradas e despesas, rode simulações e use o “Plano do Dia 05” (Blindagem → Agiota → Contas até 15 → Escola Dezembro). Tudo fica salvo neste navegador.</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- ESQUERDA: CONFIG + LISTAS -->
    <div class="card">
      <div class="hd">
        <div class="title">1) Configuração & Dados</div>
        <div class="tools">
          <button class="btn primary" id="btnSimular">Simular</button>
          <button class="btn" id="btnSalvar">Salvar</button>
          <button class="btn danger" id="btnReset">Reset (padrão)</button>
        </div>
      </div>

      <div class="body">
        <div class="row">
          <div>
            <label>Saldo atual (antes do dia 05)</label>
            <input id="saldoAtual" type="text" inputmode="decimal" placeholder="Ex.: 2400,80" />
          </div>
          <div>
            <label>Blindagem (Mercado 05→15)</label>
            <input id="blindMercado" type="text" inputmode="decimal" placeholder="Ex.: 600,00" />
          </div>
          <div>
            <label>Blindagem (Combustível 05→15)</label>
            <input id="blindComb" type="text" inputmode="decimal" placeholder="Ex.: 300,00" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Blindagem (Farmácia/Imprevisto 05→15)</label>
            <input id="blindFarm" type="text" inputmode="decimal" placeholder="Ex.: 200,00" />
          </div>
          <div>
            <label>Agiota (quitação final)</label>
            <input id="agiotaQuit" type="text" inputmode="decimal" placeholder="Ex.: 2675,00" />
          </div>
          <div>
            <label>Escola Dezembro (atraso com juros)</label>
            <input id="escolaDez" type="text" inputmode="decimal" placeholder="Ex.: 1600,00" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
          <div class="card" style="box-shadow:none;">
            <div class="hd" style="border:none; background:transparent; padding:0 0 10px 0;">
              <div class="title">Entradas (inflows)</div>
              <div class="tools">
                <button class="btn good" id="addEntrada">+ Adicionar</button>
              </div>
            </div>
            <div class="list" id="entradasList"></div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div class="hd" style="border:none; background:transparent; padding:0 0 10px 0;">
              <div class="title">Despesas (expenses)</div>
              <div class="tools">
                <button class="btn good" id="addDespesa">+ Adicionar</button>
              </div>
            </div>
            <div class="list" id="despesasList"></div>
          </div>
        </div>

        <div class="note">
          <span class="chip blue">Até dia 15</span> marque despesas que vencem até 15 (as “azuis”).<br/>
          <span class="chip warn">Projeto</span> use para coisas “fora do mensal” (ex.: quitar algo, compra única, etc.).<br/>
          <span class="chip good">Fixo</span> para contas recorrentes.
        </div>
      </div>
    </div>

    <!-- DIREITA: RESULTADOS -->
    <div class="card">
      <div class="hd">
        <div class="title">2) Resultados da Simulação</div>
        <div class="tools">
          <button class="btn" id="btnExport">Exportar JSON</button>
        </div>
      </div>
      <div class="body">
        <div class="kpis">
          <div class="kpi">
            <div class="l">Total de entradas no mês</div>
            <div class="v" id="kpiEntradas">—</div>
            <div class="h">Somatório de todas as entradas cadastradas</div>
          </div>
          <div class="kpi">
            <div class="l">Total de despesas no mês</div>
            <div class="v" id="kpiDespesas">—</div>
            <div class="h">Somatório de todas as despesas cadastradas</div>
          </div>
          <div class="kpi">
            <div class="l">Disponível no dia 05 (saldo + entradas até 05)</div>
            <div class="v" id="kpiDisponivel05">—</div>
            <div class="h">Base para executar o plano do dia 05</div>
          </div>
          <div class="kpi">
            <div class="l">Sobra após Plano do Dia 05</div>
            <div class="v" id="kpiSobra05">—</div>
            <div class="h">Após blindagem + agiota + contas até 15 + escola dez</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card" style="box-shadow:none;">
          <div class="hd" style="border:none; background:transparent; padding:0 0 8px 0;">
            <div class="title">Plano do Dia 05 (ordem automática)</div>
          </div>
          <table id="tPlano05">
            <thead>
              <tr><th>Etapa</th><th>Descrição</th><th class="r">Valor</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="note" id="msgPlano05"></div>
        </div>

        <div class="hr"></div>

        <div class="card" style="box-shadow:none;">
          <div class="hd" style="border:none; background:transparent; padding:0 0 8px 0;">
            <div class="title">Cronograma 05 / 15 / 20</div>
          </div>
          <table id="tCrono">
            <thead>
              <tr><th>Data</th><th>Entradas</th><th>Saídas sugeridas</th><th class="r">Saldo estimado</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="note small">Observação: o cronograma é uma sugestão baseada no seu “plano do dia 05” e nas despesas marcadas “até dia 15”. Ajuste vencimentos conforme sua realidade.</div>
        </div>

        <div class="hr"></div>

        <div class="card" style="box-shadow:none;">
          <div class="hd" style="border:none; background:transparent; padding:0 0 8px 0;">
            <div class="title">Fluxo por dia (entradas x saídas)</div>
          </div>
          <table id="tFluxo">
            <thead>
              <tr><th>Dia</th><th>Tipo</th><th>Nome</th><th class="r">Valor</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <p class="note" style="margin-top:14px;">
    <b>Dica GitHub Pages:</b> suba este arquivo como <span class="mono">index.html</span> no repositório → Settings → Pages → Deploy from branch → main / root.
  </p>
</main>

<script>
  // ---------- Util ----------
  const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });

  function parseBRL(str){
    if (typeof str === 'number') return str;
    if (!str) return 0;
    // aceita "2.400,80" ou "2400,80" ou "2400.80"
    const cleaned = String(str)
      .trim()
      .replace(/\s/g,'')
      .replace(/\./g,'')
      .replace(/,/g,'.')
      .replace(/[^\d.-]/g,'');
    const n = Number(cleaned);
    return isFinite(n) ? n : 0;
  }
  function fmt(n){ return BRL.format(Number(n||0)); }

  function uid(){ return Math.random().toString(36).slice(2,9); }

  // ---------- Modelo ----------
  const DEFAULT = {
    saldoAtual: 2400.80,
    blindagem: { mercado: 600, combustivel: 300, farmacia: 200 },
    agiotaQuit: 2675,
    escolaDez: 1600,
    entradas: [
      { id: uid(), dia: 5,  nome: "Salário + comissão (dia 05)", valor: 6180 },
      { id: uid(), dia: 15, nome: "Antecipação (dia 15)", valor: 1120 },
      { id: uid(), dia: 20, nome: "Salário esposa (dia 20)", valor: 3000 }
    ],
    despesas: [
      { id: uid(), dia: 15, nome: "Denise (3/12)", valor: 331.62, ate15: true, tipo: "fixo" },
      { id: uid(), dia: 15, nome: "Condomínio", valor: 300, ate15: true, tipo: "fixo" },
      { id: uid(), dia: 15, nome: "Copel", valor: 347.68, ate15: true, tipo: "fixo" },
      { id: uid(), dia: 15, nome: "Internet 1 - Claro", valor: 149.90, ate15: true, tipo: "fixo" },
      { id: uid(), dia: 15, nome: "Internet 2 - Vivo", valor: 200, ate15: true, tipo: "fixo" },
      { id: uid(), dia: 15, nome: "Reginaldo Cartão", valor: 650, ate15: true, tipo: "fixo" },

      { id: uid(), dia: 30, nome: "Psicóloga", valor: 100, ate15: false, tipo: "fixo" },
      { id: uid(), dia: 30, nome: "Hortfruit", valor: 150, ate15: false, tipo: "variavel" },
      { id: uid(), dia: 30, nome: "Mercado (mês)", valor: 1200, ate15: false, tipo: "variavel" },
      { id: uid(), dia: 30, nome: "Combustível (mês)", valor: 300, ate15: false, tipo: "variavel" },
      { id: uid(), dia: 30, nome: "Farmácia (mês)", valor: 270, ate15: false, tipo: "variavel" }
    ]
  };

  const STORAGE_KEY = "simulador_financeiro_v1";

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(DEFAULT);
      const obj = JSON.parse(raw);
      // fallback em campos
      return {
        ...structuredClone(DEFAULT),
        ...obj,
        blindagem: { ...structuredClone(DEFAULT.blindagem), ...(obj.blindagem||{}) }
      };
    }catch(e){
      return structuredClone(DEFAULT);
    }
  }
  function save(state){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = load();

  // ---------- Render Lists ----------
  const entradasList = document.getElementById("entradasList");
  const despesasList = document.getElementById("despesasList");

  function render(){
    // top config
    document.getElementById("saldoAtual").value = state.saldoAtual.toFixed(2).replace('.',',');
    document.getElementById("blindMercado").value = state.blindagem.mercado.toFixed(2).replace('.',',');
    document.getElementById("blindComb").value = state.blindagem.combustivel.toFixed(2).replace('.',',');
    document.getElementById("blindFarm").value = state.blindagem.farmacia.toFixed(2).replace('.',',');
    document.getElementById("agiotaQuit").value = state.agiotaQuit.toFixed(2).replace('.',',');
    document.getElementById("escolaDez").value = state.escolaDez.toFixed(2).replace('.',',');

    // entradas
    entradasList.innerHTML = "";
    state.entradas
      .sort((a,b)=>a.dia-b.dia)
      .forEach(ent=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="top">
            <div>
              <label>Nome</label>
              <input data-k="nome" data-id="${ent.id}" value="${escapeHtml(ent.nome)}" />
            </div>
            <div>
              <label>Dia</label>
              <input data-k="dia" data-id="${ent.id}" inputmode="numeric" value="${ent.dia}" />
            </div>
            <div>
              <label>Valor</label>
              <input data-k="valor" data-id="${ent.id}" inputmode="decimal" value="${ent.valor.toFixed(2).replace('.',',')}" />
            </div>
            <div style="display:flex; justify-content:flex-end;">
              <button class="btn danger" data-del-ent="${ent.id}">Remover</button>
            </div>
          </div>
          <div class="chips">
            <span class="chip good">Entrada</span>
          </div>
        `;
        entradasList.appendChild(el);
      });

    // despesas
    despesasList.innerHTML = "";
    state.despesas
      .sort((a,b)=>a.dia-b.dia)
      .forEach(dep=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="top">
            <div>
              <label>Nome</label>
              <input data-k="nome" data-id="${dep.id}" value="${escapeHtml(dep.nome)}" />
            </div>
            <div>
              <label>Venc. (dia)</label>
              <input data-k="dia" data-id="${dep.id}" inputmode="numeric" value="${dep.dia}" />
            </div>
            <div>
              <label>Valor</label>
              <input data-k="valor" data-id="${dep.id}" inputmode="decimal" value="${dep.valor.toFixed(2).replace('.',',')}" />
            </div>
            <div style="display:flex; justify-content:flex-end;">
              <button class="btn danger" data-del-dep="${dep.id}">Remover</button>
            </div>
          </div>

          <div class="row" style="grid-template-columns: 1fr 1fr; margin-top:10px;">
            <div>
              <label>Tipo</label>
              <select data-k="tipo" data-id="${dep.id}">
                <option value="fixo" ${dep.tipo==="fixo"?"selected":""}>Fixo</option>
                <option value="variavel" ${dep.tipo==="variavel"?"selected":""}>Variável</option>
                <option value="projeto" ${dep.tipo==="projeto"?"selected":""}>Projeto (único)</option>
              </select>
            </div>
            <div>
              <label>Marca “Até dia 15” (azul)</label>
              <select data-k="ate15" data-id="${dep.id}">
                <option value="true" ${dep.ate15? "selected":""}>Sim</option>
                <option value="false" ${!dep.ate15? "selected":""}>Não</option>
              </select>
            </div>
          </div>

          <div class="chips">
            ${dep.ate15 ? `<span class="chip blue">Até dia 15</span>` : `<span class="chip">Após 15</span>`}
            ${dep.tipo==="fixo" ? `<span class="chip good">Fixo</span>` : dep.tipo==="variavel" ? `<span class="chip warn">Variável</span>` : `<span class="chip warn">Projeto</span>`}
          </div>
        `;
        despesasList.appendChild(el);
      });

    simular(); // atualiza resultados ao render
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Bind Inputs ----------
  function bind(){
    // config inputs
    ["saldoAtual","blindMercado","blindComb","blindFarm","agiotaQuit","escolaDez"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{
        state.saldoAtual = parseBRL(document.getElementById("saldoAtual").value);
        state.blindagem.mercado = parseBRL(document.getElementById("blindMercado").value);
        state.blindagem.combustivel = parseBRL(document.getElementById("blindComb").value);
        state.blindagem.farmacia = parseBRL(document.getElementById("blindFarm").value);
        state.agiotaQuit = parseBRL(document.getElementById("agiotaQuit").value);
        state.escolaDez = parseBRL(document.getElementById("escolaDez").value);
        simular();
      });
    });

    // list changes (event delegation)
    document.body.addEventListener("input", (e)=>{
      const t = e.target;
      const id = t.getAttribute("data-id");
      const k = t.getAttribute("data-k");
      if(!id || !k) return;

      let arr = state.entradas.find(x=>x.id===id) ? state.entradas : state.despesas;
      let obj = arr.find(x=>x.id===id);
      if(!obj) return;

      if(k==="dia"){
        obj.dia = Math.max(1, Math.min(31, parseInt(t.value || "0",10) || 0));
      } else if(k==="valor"){
        obj.valor = parseBRL(t.value);
      } else if(k==="nome"){
        obj.nome = t.value;
      }
      simular();
    });

    document.body.addEventListener("change",(e)=>{
      const t = e.target;
      const id = t.getAttribute("data-id");
      const k = t.getAttribute("data-k");
      if(!id || !k) return;

      const obj = state.despesas.find(x=>x.id===id);
      if(!obj) return;

      if(k==="tipo") obj.tipo = t.value;
      if(k==="ate15") obj.ate15 = (t.value === "true");
      simular();
    });

    // delete buttons
    document.body.addEventListener("click",(e)=>{
      const t = e.target;
      const delEnt = t.getAttribute("data-del-ent");
      const delDep = t.getAttribute("data-del-dep");
      if(delEnt){
        state.entradas = state.entradas.filter(x=>x.id!==delEnt);
        render();
      }
      if(delDep){
        state.despesas = state.despesas.filter(x=>x.id!==delDep);
        render();
      }
    });

    // add
    document.getElementById("addEntrada").addEventListener("click",()=>{
      state.entradas.push({ id: uid(), dia: 5, nome:"Nova entrada", valor: 0 });
      render();
    });
    document.getElementById("addDespesa").addEventListener("click",()=>{
      state.despesas.push({ id: uid(), dia: 30, nome:"Nova despesa", valor: 0, ate15:false, tipo:"variavel" });
      render();
    });

    // actions
    document.getElementById("btnSimular").addEventListener("click", simular);
    document.getElementById("btnSalvar").addEventListener("click", ()=>{
      save(state);
      toast("Salvo neste navegador ✅");
    });
    document.getElementById("btnReset").addEventListener("click", ()=>{
      if(!confirm("Resetar para os valores padrão?")) return;
      state = structuredClone(DEFAULT);
      save(state);
      render();
      toast("Resetado ✅");
    });

    document.getElementById("btnExport").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "simulador-financeiro.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  // ---------- Simulation ----------
  function simular(){
    // KPIs básicos
    const totalEntradas = sum(state.entradas.map(x=>x.valor));
    const totalDespesas = sum(state.despesas.map(x=>x.valor));

    document.getElementById("kpiEntradas").textContent = fmt(totalEntradas);
    document.getElementById("kpiDespesas").textContent = fmt(totalDespesas);

    const saldoAtual = Number(state.saldoAtual||0);

    // disponível no dia 05 = saldo atual + entradas com dia <= 05
    const entradasAte05 = sum(state.entradas.filter(x=>x.dia<=5).map(x=>x.valor));
    const disponivel05 = saldoAtual + entradasAte05;
    document.getElementById("kpiDisponivel05").textContent = fmt(disponivel05);

    // Contas "até 15" (azuis)
    const contasAte15 = state.despesas.filter(x=>x.ate15).sort((a,b)=>a.dia-b.dia);
    const totalAte15 = sum(contasAte15.map(x=>x.valor));

    // Plano 05
    const blindTotal = (state.blindagem.mercado||0) + (state.blindagem.combustivel||0) + (state.blindagem.farmacia||0);
    const agiota = Number(state.agiotaQuit||0);
    const escolaDez = Number(state.escolaDez||0);

    const planoSaidas = [
      { etapa:"1", nome:"Blindagem", desc:"Mercado + Combustível + Farmácia/Imprevisto (05→15)", valor: blindTotal },
      { etapa:"2", nome:"Quitar agiota", desc:"Quitação final (encerra e pronto)", valor: agiota },
      { etapa:"3", nome:"Contas até dia 15", desc:"Somatório das despesas marcadas “Até dia 15”", valor: totalAte15 },
      { etapa:"4", nome:"Escola (Dezembro)", desc:"Atraso de dezembro com juros", valor: escolaDez }
    ];

    const totalPlano05 = sum(planoSaidas.map(x=>x.valor));
    const sobra05 = disponivel05 - totalPlano05;

    document.getElementById("kpiSobra05").textContent = fmt(sobra05);

    // Render tabela plano 05
    const tb = document.querySelector("#tPlano05 tbody");
    tb.innerHTML = "";
    planoSaidas.forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${x.etapa}</td>
        <td><b>${escapeHtml(x.nome)}</b><div class="small">${escapeHtml(x.desc)}</div></td>
        <td class="r mono">${fmt(x.valor)}</td>
      `;
      tb.appendChild(tr);
    });

    const trTot = document.createElement("tr");
    trTot.innerHTML = `
      <td colspan="2"><b>Total do Plano do Dia 05</b></td>
      <td class="r mono"><b>${fmt(totalPlano05)}</b></td>
    `;
    tb.appendChild(trTot);

    const msg = document.getElementById("msgPlano05");
    if(sobra05 >= 0){
      msg.innerHTML = `Status: <span class="ok">Plano viável</span>. Sobra após o dia 05: <span class="ok">${fmt(sobra05)}</span>. Dê destino à sobra (imprevistos / reserva).`;
    }else{
      msg.innerHTML = `Status: <span class="bad">Faltam ${fmt(Math.abs(sobra05))}</span> para fechar o Plano do Dia 05. Ajuste blindagem, despesas até 15, ou espere próxima entrada.`;
    }

    // Cronograma 05/15/20 (simples e útil)
    const entradasDia = d => sum(state.entradas.filter(x=>x.dia===d).map(x=>x.valor));

    const saldoDepois05 = sobra05; // porque o disponivel05 já considerou saldo+entradas <=05 e subtraiu o plano
    const saldoDepois15 = saldoDepois05 + entradasDia(15); // ainda sem descontar nada específico do dia 15
    const saldoDepois20 = saldoDepois15 + entradasDia(20);

    // Sugestões de saída em 15/20 (não “obriga”, só aponta)
    // - dia 15: reforço mercado 15→20 (metade da blindagem mercado, como padrão)
    const sugestMerc15 = Math.min((state.blindagem.mercado||0), 600); // cap simples
    // - dia 20: restante do mês (despesas NÃO ate15 + mercado restante)
    const despesasApos15 = state.despesas.filter(x=>!x.ate15);
    const totalApos15 = sum(despesasApos15.map(x=>x.valor));

    const crTb = document.querySelector("#tCrono tbody");
    crTb.innerHTML = "";

    crTb.appendChild(crRow("05", fmt(entradasAte05), `Executar Plano do Dia 05 (${fmt(totalPlano05)})`, fmt(saldoDepois05)));
    crTb.appendChild(crRow("15", fmt(entradasDia(15)), `Sugestão: reforçar mercado (15→20) até ${fmt(sugestMerc15)} + iniciar reserva`, fmt(saldoDepois15)));
    crTb.appendChild(crRow("20", fmt(entradasDia(20)), `Pagar despesas após 15 (estimado ${fmt(totalApos15)}) + reserva/imprevistos`, fmt(saldoDepois20)));

    // Fluxo por dia
    const fluxo = [];

    // saldo atual (informativo)
    fluxo.push({dia:0, tipo:"Base", nome:"Saldo atual", valor: saldoAtual});

    state.entradas.forEach(e=> fluxo.push({dia:e.dia, tipo:"Entrada", nome:e.nome, valor:e.valor}));

    // Plano do dia 05 como eventos
    planoSaidas.forEach(x=>{
      fluxo.push({dia:5, tipo:"Saída", nome:`Plano 05 — ${x.nome}`, valor: -x.valor});
    });

    // Demais despesas (para visualização)
    state.despesas.forEach(d=>{
      fluxo.push({dia:d.dia, tipo:"Despesa", nome:d.nome + (d.ate15 ? " (até 15)" : ""), valor: -d.valor});
    });

    fluxo.sort((a,b)=>a.dia-b.dia);

    const ftb = document.querySelector("#tFluxo tbody");
    ftb.innerHTML = "";
    fluxo.forEach(f=>{
      const tr = document.createElement("tr");
      const tipo = escapeHtml(f.tipo);
      const cor = f.valor >= 0 ? "ok" : "bad";
      tr.innerHTML = `
        <td class="mono">${String(f.dia).padStart(2,'0')}</td>
        <td>${tipo}</td>
        <td>${escapeHtml(f.nome)}</td>
        <td class="r mono ${cor}">${fmt(Math.abs(f.valor))}${f.valor<0?"":""}</td>
      `;
      ftb.appendChild(tr);
    });

    // auto-save leve (para não perder alterações)
    save(state);
  }

  function crRow(data, entradas, saidas, saldo){
    const tr = document.createElement("tr");
    const cls = parseBRL(saldo) >= 0 ? "ok" : "bad";
    tr.innerHTML = `
      <td class="mono">${data}</td>
      <td>${entradas}</td>
      <td>${saidas}</td>
      <td class="r mono ${cls}">${saldo}</td>
    `;
    return tr;
  }

  function sum(arr){ return arr.reduce((a,b)=>a+(Number(b)||0),0); }

  // ---------- Toast ----------
  function toast(msg){
    const d = document.createElement("div");
    d.textContent = msg;
    d.style.position="fixed";
    d.style.left="50%";
    d.style.bottom="18px";
    d.style.transform="translateX(-50%)";
    d.style.background="rgba(0,0,0,.78)";
    d.style.border="1px solid rgba(255,255,255,.18)";
    d.style.padding="10px 12px";
    d.style.borderRadius="12px";
    d.style.color="#fff";
    d.style.fontSize="12px";
    d.style.zIndex="999";
    document.body.appendChild(d);
    setTimeout(()=>{ d.remove(); }, 1600);
  }

  // ---------- Init ----------
  render();
  bind();
</script>
</body>
</html>
